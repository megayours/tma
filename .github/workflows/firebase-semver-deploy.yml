name: Deploy to Firebase Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set build metadata
        id: build-meta
        run: |
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_hash_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          # Use package.json version as app version
          echo "app_version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Write .env.production from secret
        run: |
          printf "%s" "${PRODUCTION_ENV_FILE}" > .env.production
          cp .env.production .env
        env:
          PRODUCTION_ENV_FILE: ${{ secrets.PRODUCTION_ENV_FILE }}

      # print the secret
      - name: Print secret
        run: |
          echo .env
          echo ${{ secrets.PRODUCTION_ENV_FILE }}
          cat .env

      - name: Install Firebase CLI
        run: bun i -g firebase-tools

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Build (prod)
        env:
          NODE_ENV: production
          # Build metadata
          VITE_APP_VERSION: ${{ steps.build-meta.outputs.app_version }}
          VITE_GIT_COMMIT_HASH: ${{ steps.build-meta.outputs.commit_hash }}
          VITE_GIT_BRANCH: ${{ steps.build-meta.outputs.branch }}
          VITE_BUILD_TIMESTAMP: ${{ steps.build-meta.outputs.timestamp }}
          # Sentry configuration - environment from GitHub context
          VITE_SENTRY_ENVIRONMENT: production
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT_PRODUCTION }}
        run: |
          if [ -f package.json ] && jq -e '.scripts.build' package.json >/dev/null 2>&1; then
            echo "Building project..."
            bun run build
            echo "Build completed successfully"
            echo "Build output:"
            ls -lah dist/
          else
            echo "No build script. Skipping."
          fi

      - name: Check Firebase config
        run: |
          echo "Checking Firebase configuration..."
          if [ -f .firebaserc ]; then
            echo "Firebase config found:"
            cat .firebaserc
          else
            echo "WARNING: .firebaserc not found"
          fi
          if [ -f firebase.json ]; then
            echo "Firebase hosting config:"
            cat firebase.json
          else
            echo "WARNING: firebase.json not found"
          fi

      - name: Deploy to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Starting Firebase deployment..."
          echo "Firebase CLI version:"
          firebase --version
          echo "Deploying to Firebase..."
          firebase deploy --non-interactive --debug
          echo "Deployment completed successfully!"
