/**
 * Self-Destructing Service Worker
 *
 * This service worker is designed to replace the old Workbox service worker
 * that was generated by vite-plugin-pwa (removed in commit 7445758).
 *
 * Purpose:
 * - Installs itself to replace the old service worker
 * - Immediately takes control of all pages
 * - Clears all caches (including workbox-precache-v2)
 * - Unregisters itself
 * - Notifies the app to reload with fresh content
 *
 * This is a one-time migration strategy. After all users have migrated
 * (typically 30 days), this file can be removed.
 *
 * See: SERVICE_WORKER_CLEANUP.md for more details
 */

self.addEventListener('install', (event) => {
  console.log('[SW-Cleanup] Self-destructing service worker installed');
  // Skip waiting immediately - don't wait for old SW to become redundant
  self.skipWaiting();
});

self.addEventListener('activate', (event) => {
  console.log('[SW-Cleanup] Self-destructing service worker activated');

  event.waitUntil(
    (async () => {
      try {
        // Take control of all pages immediately
        await self.clients.claim();
        console.log('[SW-Cleanup] Claimed all clients');

        // Clear all caches
        const cacheNames = await caches.keys();
        if (cacheNames.length > 0) {
          await Promise.all(
            cacheNames.map(cacheName => caches.delete(cacheName))
          );
          console.log('[SW-Cleanup] Cleared all caches:', cacheNames);
        } else {
          console.log('[SW-Cleanup] No caches to clear');
        }

        // Unregister this service worker
        const registration = await self.registration;
        const unregistered = await registration.unregister();
        console.log('[SW-Cleanup] Service worker unregistered:', unregistered);

        // Notify all clients to reload
        const clients = await self.clients.matchAll({ type: 'window' });
        clients.forEach(client => {
          client.postMessage({ type: 'SW_CLEANUP_COMPLETE' });
        });
        console.log('[SW-Cleanup] Notified', clients.length, 'client(s) to reload');
      } catch (error) {
        console.error('[SW-Cleanup] Error during cleanup:', error);
      }
    })()
  );
});

// Passthrough fetch handler - don't intercept any requests
// This ensures that while the cleanup is happening, all requests
// go directly to the network
self.addEventListener('fetch', (event) => {
  // Just let requests pass through to network
  return;
});
